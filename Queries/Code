-- Top 10 Closed Deals
SELECT "sp"."opportunity_id","sp"."sales_agent","sp"."account", "sp"."deal_stage", "sp"."close_value", "a"."sector" from "sales_pipeline" as sp 
inner join accounts as a
	on "sp"."account" = "a"."account"
where "deal_stage" = 'Won'
order by "close_value" desc
limit 10

Takeaway: 40% of the biggest deal closed were within the entertainment sector
Elease Gluck closed 50% of the 10 highest deals for the company - yet she is not in top 10 sales agents for the year

--Product Popularity: Count how many deals were created for each product.
select "product",count("opportunity_id") as "Number of Deals" from "sales_pipeline"
group by "product"
order by "Number of Deals" DESC;


Takeaway: GTX Basic had the highest number of deals, but the GTX Pro recorded the highest number revenue. THis could be due to price sensitivity as the GTX Basic is the second cheapest product, however the GTX Pro still sold quite a high amount of units being the third most.
GTK 500 had the highest median by far

--Active Pipeline: Find all deals that are still in 'Prospecting' or 'Engaging' with a close_value > 0.
select "opportunity_id", "deal_stage", "close_value" from "sales_pipeline"
where deal_stage = 'Engaging' and close_value > 0

-- Win Rate by Sales Agent: Calculate the percentage of "Won" deals versus "Lost" deals for every agent.
select sales_agent, COUNT('opportunity_id') as "Number of Ops",
SUM(CASE WHEN deal_stage = 'Won' THEN 1 ELSE 0 END) as "deals_won",
ROUND(SUM(CASE WHEN deal_stage = 'Won' THEN 1 ELSE 0 END) * 1.0 / COUNT('opportunity_id'), 2) as "win_rate"
from "sales_pipeline"
group by sales_agent
order by "win_rate" DESC;


Takeaway: Reed Clapper had the highest winrate at 65% with August and Feburary being his highest closed months, Software and retailer were his go to sectors, compared to the last place in terms of win rate Lajuana Vencill, he had less opportunities (237 vs 311) but what seems to be a big difference was his pipeline, by the end of the year he had no prospects they were still being engaged or being propsected. This was a pattern across the board as typically those who were high performing by the end of the year had a much clearer and linear pipeline despite their number of opportunities compared to those who had a worse win rate	

--Sector Profitability: Join the Accounts and Pipeline tables to find which Sector (Retail, Tech, etc.) has the highest average deal size.
select a.sector, ROUND(AVG(close_value), 2) as "avg_close_value" from sales_pipeline as p
inner join accounts as a
	on "p"."account" = "a"."account"
group by a.sector
order by "avg_close_value" DESC;


Takeaway: Retail sold the highest amount in terms of revenue followed by Tech then medical, however the sectors with the highest average deal size is actually different with entertainment having the highest average then finance, software. This might be due to frequency however at a quick glance entertainment has less deals than retail so it must be the deal size of the opportunities on average are higher


-- Revenue by Manager: Summarize the total revenue generated by each manager’s team.
select st."manager", SUM(sp."close_value") as "Total Revenue" from sales_pipeline as sp
inner join sales_teams as st
	on sp."sales_agent" = st."sales_agent"
group by st."manager"
order by "Total Revenue" DESC


Takeaways: Melvin Marxen is the top performing manager then Summer Sewald with Dustin Brinkmann coming in last - can look later ino why this is looking ath what office they are in as well as what industries/accounts they cover




-- Sales Velocity (Cycle Time): Calculate the average number of days it takes for a deal to move from engage_date to close_date.
select sp.product ,ROUND(AVG(sp.close_date - sp.engage_date)) as "avg_days_to_close"
from sales_pipeline sp
where sp.close_date is not null
	and sp.engage_date is not null
group by sp.product


select COUNT(deal_stage) from sales_pipeline -- total number in deal stages are 8,800

-- Takeaway: GTX Pro has the shortest average days to close with GTX 500 being the slowerest, interesting that GTX pro is also the best selling product. Can see if there is any correlation between the days to close and it’’s revenue. GTX 500 has also generated almost the lead amount of revenue


– - Weighted Forecast: Use a CASE statement to multiply the close_value by a probability (e.g., Prospecting = 10%, Engaging = 30%, Won = 100%) to see the "Expected Revenue" currently in the pipeline.
SELECT
   deal_stage,
   COUNT(opportunity_id) AS "no_deals",
   SUM(close_value) AS "Raw_Value",
   -- Here is the weighted math
   SUM(CASE
       WHEN deal_stage = 'Won' THEN close_value * 1.0
       WHEN deal_stage = 'Engaging' THEN close_value * 0.18
       WHEN deal_stage = 'Prospecting' THEN close_value * 0.057
       WHEN deal_stage = 'Lost' THEN close_value * 0.0
       ELSE 0
   END) AS "Weighted_Forecast"
FROM sales_pipeline
GROUP BY deal_stage;
